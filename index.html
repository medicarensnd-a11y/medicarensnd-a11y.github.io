<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Medicare QR Scanner ‚Äî Patient / Doctor</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* -------------------------------------------------------
   THEME
------------------------------------------------------- */
:root {
  --bg:#0f0f14;
  --glass:rgba(255,255,255,0.08);
  --glass2:rgba(255,255,255,0.04);
  --accent:#00aaff;
  --accent2:#008cff;
  --text:#fff;
  --muted:#b8c0c7;
  --muted2:#8f9aa3;
  --radius:14px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Inter",sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* -------------------------------------------------------
   GENERAL LAYOUT
------------------------------------------------------- */
.app{
  max-width:820px;
  margin:auto;
  padding:20px;
}
.card{
  background:var(--glass);
  backdrop-filter:blur(10px);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 10px 35px rgba(0,0,0,0.4);
  margin-top:20px;
}

/* -------------------------------------------------------
   HEADERS
------------------------------------------------------- */
h1{
  margin:10px 0 4px;
  font-size:26px;
  text-align:center;
  font-weight:600;
}
.lead{
  text-align:center;
  margin:0;
  color:var(--muted);
  font-size:14px;
}

/* -------------------------------------------------------
   BUTTONS
------------------------------------------------------- */
.btn{
  padding:10px 16px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.12);
  background:var(--glass2);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  transition:0.2s;
}
.btn:hover{
  background:rgba(255,255,255,0.15);
}
.btn.primary{
  background:linear-gradient(90deg,var(--accent) 0%,var(--accent2) 100%);
  border:none;
}
.btn.primary:hover{
  opacity:0.85;
}

/* -------------------------------------------------------
   NAV BUTTONS
------------------------------------------------------- */
nav{
  display:flex;
  justify-content:center;
  gap:12px;
}

/* -------------------------------------------------------
   PAGES
------------------------------------------------------- */
.page{display:none;}
.page.active{display:block;}

/* -------------------------------------------------------
   VIDEO
------------------------------------------------------- */
.video-square{
  width:100%;
  max-width:420px;
  margin:20px auto;
  aspect-ratio:1/1;
  border-radius:16px;
  overflow:hidden;
  background:#000;
  position:relative;
  border:1px solid rgba(255,255,255,0.08);
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}
.scan-indicator{
  position:absolute;
  top:12px;
  left:12px;
  background:rgba(0,0,0,0.55);
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  color:var(--muted);
}

/* -------------------------------------------------------
   FIELDS
------------------------------------------------------- */
.fields{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:15px;
}
.field{
  display:flex;
  gap:10px;
  padding:12px;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
}
.label{
  min-width:140px;
  font-weight:600;
}
.value{
  color:var(--muted);
}
.value.none{
  color:var(--muted2);
  font-style:italic;
}

/* -------------------------------------------------------
   PRESCRIPTIONS
------------------------------------------------------- */
.thumbs{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.thumbs img{
  width:90px;
  height:90px;
  border-radius:8px;
  object-fit:cover;
  border:1px solid rgba(255,255,255,0.1);
}

/* -------------------------------------------------------
   MODAL
------------------------------------------------------- */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:3000;
}
.modal{
  width:90%;
  max-width:420px;
  padding:20px;
  background:var(--glass);
  border-radius:14px;
  backdrop-filter:blur(10px);
}
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.1);
  background:var(--glass2);
  margin-top:10px;
  color:#fff;
}

/* -------------------------------------------------------
   FOOTER
------------------------------------------------------- */
footer{
  text-align:center;
  margin:30px 0 60px;
  color:var(--muted2);
  font-size:13px;
}
</style>
</head>
<body>

<div class="app">
  <header>
    <h1>Medicare QR Scanner</h1>
    <p class="lead">Scan QR ‚Üí View patient info. Doctor mode unlocks prescriptions.</p>
  </header>

  <!-- HOME -->
  <div class="card page active" id="homePage">
    <nav>
      <button class="btn primary" id="btnPatient">üë§ Regular Mode</button>
      <button class="btn" id="btnDoctor">üë®‚Äç‚öïÔ∏è Doctor Mode</button>
    </nav>
    <p style="text-align:center;margin-top:12px;color:var(--muted)">
      QR code now expects a JSON object like:<br>
      <code>{"name": "John", "age": "40"}</code>
    </p>
  </div>

  <!-- SCANNER -->
  <div class="card page" id="scannerPage">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <strong id="modeTitle">Scanner</strong><br>
        <span style="font-size:13px;color:var(--muted)" id="modeHint"></span>
      </div>
      <button class="btn" id="btnBack">‚Üê Home</button>
    </div>

    <div class="video-square">
      <div class="scan-indicator" id="scanIndicator">Idle</div>
      <video id="video" autoplay playsinline></video>
    </div>

    <div style="text-align:center;display:flex;gap:10px;justify-content:center;">
      <button class="btn primary" id="startScanBtn">Start Scan</button>
      <button class="btn" id="pauseBtn">Pause</button>
      <button class="btn" id="switchBtn" style="display:none;">Switch</button>
    </div>
  </div>

  <!-- INFO -->
  <div class="card page" id="infoPage">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <strong>Patient Info</strong><br>
        <span style="font-size:13px;color:var(--muted)" id="infoSub"></span>
      </div>
      <button class="btn" id="btnRescan">Scan Again</button>
    </div>

    <div class="fields" id="fieldsContainer"></div>
    <div id="prescriptions"></div>

    <p style="font-size:13px;color:var(--muted);margin-top:15px;">
      All processing stays on your device.
    </p>
  </div>

  <footer>Built with care.</footer>
</div>

<!-- DOCTOR MODAL -->
<div id="doctorModal" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <h3>Doctor Access</h3>
    <p style="color:var(--muted)">Enter access code.</p>
    <input type="password" id="accessCode" placeholder="Access code">
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="btn primary" id="submitCode">Unlock</button>
      <button class="btn" id="cancelCode">Cancel</button>
    </div>
    <p id="codeMsg" style="margin-top:8px;color:#f77;"></p>
  </div>
</div>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
/* -------------------------------------------------------
   CONFIG
------------------------------------------------------- */
const doctorCodes = ["6kdw", "1wq9", "67sq"];
let mode = "regular";
let doctorUnlocked = false;
let devices = [];
let currentDeviceIndex = 0;
let stream = null;
let scanning = false;
let lastSeen = 0;
let cooldown = 1200;

/* -------------------------------------------------------
   ELEMENTS
------------------------------------------------------- */
const homePage = document.getElementById("homePage");
const scannerPage = document.getElementById("scannerPage");
const infoPage = document.getElementById("infoPage");
const btnPatient = document.getElementById("btnPatient");
const btnDoctor = document.getElementById("btnDoctor");
const btnBack = document.getElementById("btnBack");
const btnRescan = document.getElementById("btnRescan");
const startScanBtn = document.getElementById("startScanBtn");
const pauseBtn = document.getElementById("pauseBtn");
const switchBtn = document.getElementById("switchBtn");
const scanIndicator = document.getElementById("scanIndicator");
const fieldsContainer = document.getElementById("fieldsContainer");
const prescriptionsDiv = document.getElementById("prescriptions");

const modeTitle = document.getElementById("modeTitle");
const modeHint = document.getElementById("modeHint");

const video = document.getElementById("video");
const doctorModal = document.getElementById("doctorModal");
const accessCode = document.getElementById("accessCode");
const submitCode = document.getElementById("submitCode");
const cancelCode = document.getElementById("cancelCode");
const codeMsg = document.getElementById("codeMsg");

/* -------------------------------------------------------
   UTILS
------------------------------------------------------- */
function escapeHTML(x){
  const p=document.createElement("p");
  p.textContent=x;
  return p.innerHTML;
}
function isImg(u){
  return /\.(jpg|jpeg|png|gif|webp)$/i.test(u);
}

/* -------------------------------------------------------
   JSON PARSER
------------------------------------------------------- */
function parsePayload(raw){
  try{
    const obj = JSON.parse(raw);
    if(typeof obj !== "object" || Array.isArray(obj) || obj === null) return [];
    return Object.entries(obj).map(([k,v])=>({
      label:k,
      value:String(v)
    }));
  }catch(e){
    console.warn("Invalid JSON:",raw);
    return [];
  }
}

/* -------------------------------------------------------
   PAGE SWITCHER
------------------------------------------------------- */
function show(name){
  homePage.classList.remove("active");
  scannerPage.classList.remove("active");
  infoPage.classList.remove("active");
  if(name==="home") homePage.classList.add("active");
  if(name==="scanner") scannerPage.classList.add("active");
  if(name==="info") infoPage.classList.add("active");
}

function setMode(m){
  mode = m;
  modeTitle.textContent = m==="doctor" ? "Doctor Scanner" : "Patient Scanner";
  modeHint.textContent = 
    m==="doctor"
      ? doctorUnlocked ? "Unlocked" : "Locked ‚Äî enter code"
      : "Regular access";
}

/* -------------------------------------------------------
   CAMERA
------------------------------------------------------- */
async function enumerate(){
  try{
    const dev = await navigator.mediaDevices.enumerateDevices();
    devices = dev.filter(d=>d.kind==="videoinput");
    switchBtn.style.display = devices.length>1?"block":"none";
  }catch(e){
    devices = [];
  }
}
function stopCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}
async function startCam(id=null){
  stopCam();
  const c = {
    video:{
      deviceId:id?{exact:id}:undefined,
      facingMode:id?undefined:{ideal:"environment"},
      width:{ideal:1280},
      height:{ideal:1280},
      aspectRatio:{ideal:1}
    }
  };
  try{
    stream = await navigator.mediaDevices.getUserMedia(c);
    video.srcObject = stream;
    await video.play();
    return true;
  }catch(e){
    scanIndicator.textContent="Camera blocked or unavailable";
    return false;
  }
}

/* -------------------------------------------------------
   SCAN LOOP
------------------------------------------------------- */
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");

function loop(){
  if(!scanning) return;
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(img.data,img.width,img.height);

    if(code && code.data){
      const now = Date.now();
      if(now-lastSeen > cooldown){
        lastSeen = now;
        onQR(code.data);
      }
    }
  }
  requestAnimationFrame(loop);
}

/* -------------------------------------------------------
   QR HANDLER
------------------------------------------------------- */
function onQR(data){
  scanning=false;
  stopCam();

  const parsed = parsePayload(data);
  showInfo(parsed,data);
}

/* -------------------------------------------------------
   INFO RENDER
------------------------------------------------------- */
function showInfo(fields, raw){
  show("info");
  document.getElementById("infoSub").textContent = "Scanned " + new Date().toLocaleString();
  fieldsContainer.innerHTML="";
  prescriptionsDiv.innerHTML="";

  const doctorKeys=["prescription","prescriptions","rx"];

  // fields
  fields.forEach(({label,value})=>{
    const low=label.toLowerCase().trim();
    const wrapper=document.createElement("div");
    wrapper.className="field";

    if(mode==="doctor" && doctorUnlocked && doctorKeys.includes(low)){
      const urls=value.split(/[\s,|]+/).filter(Boolean);
      const imgs=urls.filter(u=>isImg(u));
      const non=urls.filter(u=>!isImg(u));

      const title=document.createElement("div");
      title.className="field";
      title.innerHTML=`<div class="label">Prescriptions:</div>
                       <div class="value">${urls.length} file(s)</div>`;
      prescriptionsDiv.appendChild(title);

      const box=document.createElement("div");
      box.className="thumbs";
      urls.forEach(u=>{
        const a=document.createElement("a");
        a.href=u;
        a.target="_blank";
        a.rel="noopener";

        if(isImg(u)){
          const img=document.createElement("img");
          img.src=u;
          a.appendChild(img);
        }else{
          const t=document.createElement("div");
          t.className="field";
          t.textContent=u;
          a.appendChild(t);
        }
        box.appendChild(a);
      });
      prescriptionsDiv.appendChild(box);
    }else{
      wrapper.innerHTML=
        `<div class="label">${escapeHTML(label)}:</div>
         <div class="value">${escapeHTML(value)}</div>`;
      fieldsContainer.appendChild(wrapper);
    }
  });

  // Raw
  const rawBox=document.createElement("div");
  rawBox.className="field";
  rawBox.innerHTML=`<div class="label">Raw:</div>
    <div class="value">${escapeHTML(raw)}</div>`;
  fieldsContainer.appendChild(rawBox);
}

/* -------------------------------------------------------
   UI EVENTS
------------------------------------------------------- */
btnPatient.onclick=()=>{
  doctorUnlocked=false;
  setMode("regular");
  show("scanner");
  scanIndicator.textContent="Idle";
};
btnDoctor.onclick=()=>{
  setMode("doctor");
  doctorModal.style.display="flex";
  accessCode.value="";
  codeMsg.textContent="";
  accessCode.focus();
};

submitCode.onclick=()=>{
  const c = accessCode.value.trim();
  if(doctorCodes.includes(c)){
    doctorUnlocked=true;
    doctorModal.style.display="none";
    show("scanner");
  }else{
    codeMsg.textContent="Incorrect code.";
  }
};
cancelCode.onclick=()=>doctorModal.style.display="none";

btnBack.onclick=()=>{
  scanning=false;
  stopCam();
  show("home");
};

btnRescan.onclick=async()=>{
  fieldsContainer.innerHTML="";
  prescriptionsDiv.innerHTML="";
  show("scanner");
  scanIndicator.textContent="Scanning‚Ä¶";
  await startCam();
  scanning=true;
  loop();
};

startScanBtn.onclick=async()=>{
  scanIndicator.textContent="Scanning‚Ä¶";
  await enumerate();
  if(devices.length){
    await startCam(devices[0].deviceId);
  }else{
    await startCam(null);
  }
  scanning=true;
  loop();
};

pauseBtn.onclick=()=>{
  if(scanning){
    scanning=false;
    stopCam();
    pauseBtn.textContent="Resume";
    scanIndicator.textContent="Paused";
  }else{
    pauseBtn.textContent="Pause";
    scanIndicator.textContent="Scanning‚Ä¶";
    startCam();
    scanning=true;
    loop();
  }
};

switchBtn.onclick=async()=>{
  if(!devices.length) return;
  currentDeviceIndex=(currentDeviceIndex+1)%devices.length;
  await startCam(devices[currentDeviceIndex].deviceId);
};

/* -------------------------------------------------------
   INIT
------------------------------------------------------- */
show("home");
</script>
</body>
</html>
