<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Medicare QR Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f0f14;
            color: #fff;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin: 16px 0 4px;
        }

        .subtitle {
            text-align: center;
            color: #b8c0c7;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .page {
            display: none;
            flex: 1;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
            margin: 6px;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:active {
            opacity: 0.6;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00aaff 0%, #008cff 100%);
            border: none;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 12px;
            display: block;
            margin: 12px auto;
            background: #000;
            object-fit: cover;
        }

        .video-container {
            position: relative;
            max-width: 400px;
            margin: 12px auto;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            margin: 0;
            object-fit: cover;
        }

        .status {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #b8c0c7;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 10;
            pointer-events: none;
        }

        .info-field {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 6px 0;
            font-size: 12px;
            gap: 10px;
            align-items: flex-start;
        }

        .info-label {
            font-weight: 600;
            min-width: 80px;
            flex-shrink: 0;
            padding-top: 2px;
        }

        .info-value {
            color: #b8c0c7;
            word-break: break-word;
            flex: 1;
            text-align: right;
            font-size: 11px;
            line-height: 1.4;
        }

        .info-value a {
            color: #00aaff;
            text-decoration: none;
            border-bottom: 1px solid #00aaff;
            transition: color 0.2s;
        }

        .info-value a:active {
            color: #008cff;
            border-bottom-color: #008cff;
        }

        .prescriptions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .prescription-item {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .prescription-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .prescription-item a {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: inherit;
            font-size: 24px;
            border: none;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .modal-backdrop.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .modal h2 {
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal p {
            font-size: 12px;
            color: #b8c0c7;
            margin-bottom: 12px;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 13px;
            margin-bottom: 12px;
            font-family: inherit;
        }

        input::placeholder {
            color: #8f9aa3;
        }

        input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: #00aaff;
        }

        .error {
            color: #ff6b6b;
            font-size: 11px;
            margin: 6px 0;
            min-height: 14px;
        }

        footer {
            text-align: center;
            color: #8f9aa3;
            font-size: 11px;
            margin-top: 20px;
            padding-bottom: 16px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-info > div {
            flex: 1;
        }

        .header-info strong {
            font-size: 13px;
            display: block;
            margin-bottom: 2px;
        }

        .header-info span {
            font-size: 11px;
            color: #b8c0c7;
        }

        .home-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .home-buttons .btn {
            width: 100%;
            padding: 12px;
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 20px;
                margin: 12px 0 4px;
            }

            .subtitle {
                font-size: 11px;
            }

            .card {
                padding: 12px;
                margin-bottom: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
                margin: 4px;
            }

            .info-field {
                padding: 8px;
                font-size: 11px;
                margin: 4px 0;
            }

            .info-label {
                min-width: 70px;
            }

            .info-value {
                font-size: 10px;
            }

            .prescription-item {
                width: 60px;
                height: 60px;
            }

            video {
                margin: 8px auto;
            }

            .modal {
                width: 95%;
                padding: 16px;
            }

            .home-buttons .btn {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Medicare QR</h1>
        <p class="subtitle">Patient & Doctor Access</p>

        <!-- HOME PAGE -->
        <div class="page active" id="homePage">
            <div class="card">
                <div class="home-buttons">
                    <button class="btn btn-primary" onclick="startPatient()">üë§ Patient Mode</button>
                    <button class="btn" onclick="startDoctor()">üë®‚Äç‚öïÔ∏è Doctor Mode</button>
                </div>
                <p style="text-align: center; font-size: 11px; color: #b8c0c7; margin: 12px 0 0;">
                    QR Format: {"name": "John", "age": "40"}
                </p>
            </div>
        </div>

        <!-- SCANNER PAGE -->
        <div class="page" id="scannerPage">
            <div class="card">
                <div class="header-info">
                    <div>
                        <strong id="modeTitle">Scanner</strong>
                        <span id="modeHint"></span>
                    </div>
                    <button class="btn" onclick="goHome()">Home</button>
                </div>
            </div>

            <div class="video-container">
                <video id="video" autoplay playsinline muted></video>
                <div class="status" id="status">Idle</div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="startBtn" onclick="startScanning()">Start Scan</button>
                <button class="btn" id="pauseBtn" style="display: none;" onclick="togglePause()">Pause</button>
            </div>
        </div>

        <!-- INFO PAGE -->
        <div class="page" id="infoPage">
            <div class="card">
                <div class="header-info">
                    <div>
                        <strong style="font-size: 13px;">Patient Info</strong>
                        <span id="infoTime"></span>
                    </div>
                    <button class="btn" onclick="rescan()">Scan Again</button>
                </div>
            </div>

            <div id="infoContainer" style="flex: 1; overflow-y: auto;"></div>
            <div id="prescContainer"></div>

            <div class="card" style="margin-top: auto;">
                <p style="font-size: 10px; color: #8f9aa3; margin: 0;">
                    ‚úì All processing stays on your device. No cloud upload.
                </p>
            </div>
        </div>

        <footer>Built with care ‚Ä¢ 2025</footer>
    </div>

    <!-- DOCTOR MODAL -->
    <div class="modal-backdrop" id="doctorModal">
        <div class="modal">
            <h2>Doctor Access</h2>
            <p>Enter your access code</p>
            <input type="password" id="codeInput" placeholder="Access code" autocomplete="off">
            <div class="btn-group" style="margin: 0; gap: 8px;">
                <button class="btn btn-primary" style="flex: 1; margin: 0;" onclick="submitCode()">Unlock</button>
                <button class="btn" style="flex: 1; margin: 0;" onclick="closeModal()">Cancel</button>
            </div>
            <div class="error" id="codeError"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <script>
        // ========== CONFIG ==========
        const DOCTOR_CODES = ["6kdw", "1wq9", "67sq"];
        const SCAN_COOLDOWN = 800;
        const CANVAS_SIZE = 480;

        // ========== STATE ==========
        let state = {
            mode: "patient",
            doctorUnlocked: false,
            isScanning: false,
            isPaused: false,
            lastScanTime: 0,
            stream: null,
            animFrameId: null
        };

        // ========== DOM ELEMENTS ==========
        const video = document.getElementById("video");
        const status = document.getElementById("status");
        const modeTitle = document.getElementById("modeTitle");
        const modeHint = document.getElementById("modeHint");
        const doctorModal = document.getElementById("doctorModal");
        const codeInput = document.getElementById("codeInput");
        const codeError = document.getElementById("codeError");
        const infoContainer = document.getElementById("infoContainer");
        const prescContainer = document.getElementById("prescContainer");

        // ========== CANVAS SETUP ==========
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });

        // ========== PAGE NAVIGATION ==========
        function showPage(pageId) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById(pageId).classList.add("active");
        }

        // ========== CAMERA CONTROL ==========
        async function startCamera() {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                video.srcObject = state.stream;
                return true;
            } catch (error) {
                status.textContent = "‚ùå Camera blocked";
                console.error("Camera error:", error);
                return false;
            }
        }

        function stopCamera() {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
                state.stream = null;
            }
        }

        // ========== SCANNING LOOP ==========
        function scanQR() {
            if (!state.isScanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const w = Math.min(video.videoWidth, CANVAS_SIZE);
                const h = Math.min(video.videoHeight, CANVAS_SIZE);

                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(video, 0, 0, w, h);

                const imageData = ctx.getImageData(0, 0, w, h);
                const qrCode = jsQR(imageData.data, w, h);

                if (qrCode && qrCode.data) {
                    const now = Date.now();
                    if (now - state.lastScanTime > SCAN_COOLDOWN) {
                        state.lastScanTime = now;
                        handleQRDetected(qrCode.data);
                        return;
                    }
                }
            }

            state.animFrameId = requestAnimationFrame(scanQR);
        }

        function stopScanning() {
            state.isScanning = false;
            if (state.animFrameId) {
                cancelAnimationFrame(state.animFrameId);
                state.animFrameId = null;
            }
        }

        // ========== QR HANDLER ==========
        function handleQRDetected(rawData) {
            stopScanning();
            stopCamera();
            displayResults(rawData);
        }

        // ========== PARSE & DISPLAY ==========
        function parseQRData(raw) {
            try {
                const obj = JSON.parse(raw);
                if (typeof obj !== "object" || obj === null || Array.isArray(obj)) return [];
                return Object.entries(obj).map(([key, value]) => ({
                    key,
                    value: String(value)
                }));
            } catch (e) {
                return [];
            }
        }

        function escapeHTML(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        function isImageURL(url) {
            return /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
        }

        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function makeURLsClickable(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);
            const fragment = document.createDocumentFragment();

            parts.forEach(part => {
                if (isValidURL(part)) {
                    const link = document.createElement("a");
                    link.href = part;
                    link.target = "_blank";
                    link.rel = "noopener";
                    link.textContent = part.substring(0, 40) + (part.length > 40 ? "..." : "");
                    fragment.appendChild(link);
                } else {
                    fragment.appendChild(document.createTextNode(part));
                }
            });

            return fragment;
        }

        function displayResults(rawData) {
            showPage("infoPage");
            document.getElementById("infoTime").textContent = new Date().toLocaleString();

            infoContainer.innerHTML = "";
            prescContainer.innerHTML = "";

            const fields = parseQRData(rawData);
            const doctorFieldKeys = ["prescription", "prescriptions", "rx"];

            fields.forEach(({ key, value }) => {
                const isDoctor = state.mode === "doctor" && state.doctorUnlocked;
                const isDoctorField = doctorFieldKeys.includes(key.toLowerCase().trim());

                if (isDoctor && isDoctorField) {
                    const urls = value.split(/[\s,|]+/).filter(Boolean);
                    if (urls.length === 0) return;

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "info-field";
                    titleDiv.innerHTML = `<span class="info-label">Prescriptions:</span><span class="info-value">${urls.length} file(s)</span>`;
                    prescContainer.appendChild(titleDiv);

                    const container = document.createElement("div");
                    container.className = "prescriptions";

                    urls.forEach(url => {
                        const item = document.createElement("div");
                        item.className = "prescription-item";

                        if (isImageURL(url)) {
                            const link = document.createElement("a");
                            link.href = url;
                            link.target = "_blank";
                            link.rel = "noopener";
                            const img = document.createElement("img");
                            img.src = url;
                            img.alt = "Prescription";
                            link.appendChild(img);
                            item.appendChild(link);
                        } else {
                            const link = document.createElement("a");
                            link.href = url;
                            link.target = "_blank";
                            link.rel = "noopener";
                            link.textContent = "üìÑ";
                            item.appendChild(link);
                        }
                        container.appendChild(item);
                    });

                    prescContainer.appendChild(container);
                } else {
                    const fieldDiv = document.createElement("div");
                    fieldDiv.className = "info-field";

                    const labelSpan = document.createElement("span");
                    labelSpan.className = "info-label";
                    labelSpan.textContent = key;

                    const valueSpan = document.createElement("span");
                    valueSpan.className = "info-value";

                    // Check if value contains URLs
                    if (isValidURL(value) || value.includes("http")) {
                        valueSpan.appendChild(makeURLsClickable(value));
                    } else {
                        valueSpan.textContent = value;
                    }

                    fieldDiv.appendChild(labelSpan);
                    fieldDiv.appendChild(valueSpan);
                    infoContainer.appendChild(fieldDiv);
                }
            });

            const rawDiv = document.createElement("div");
            rawDiv.className = "info-field";
            const rawLabel = document.createElement("span");
            rawLabel.className = "info-label";
            rawLabel.textContent = "Raw:";

            const rawValue = document.createElement("span");
            rawValue.className = "info-value";
            rawValue.style.fontSize = "10px";
            rawValue.style.wordBreak = "break-all";

            if (rawData.includes("http")) {
                rawValue.appendChild(makeURLsClickable(rawData));
            } else {
                rawValue.textContent = rawData;
            }

            rawDiv.appendChild(rawLabel);
            rawDiv.appendChild(rawValue);
            infoContainer.appendChild(rawDiv);
        }

        // ========== UI EVENTS ==========
        function startPatient() {
            state.mode = "patient";
            state.doctorUnlocked = false;
            modeTitle.textContent = "Patient Scanner";
            modeHint.textContent = "Regular access";
            showPage("scannerPage");
            status.textContent = "Idle";
            document.getElementById("startBtn").style.display = "block";
            document.getElementById("pauseBtn").style.display = "none";
        }

        function startDoctor() {
            state.mode = "doctor";
            modeTitle.textContent = "Doctor Scanner";
            modeHint.textContent = state.doctorUnlocked ? "‚úì Unlocked" : "üîí Locked";
            doctorModal.classList.add("active");
            codeInput.value = "";
            codeError.textContent = "";
            setTimeout(() => codeInput.focus(), 100);
        }

        function closeModal() {
            doctorModal.classList.remove("active");
        }

        function submitCode() {
            const code = codeInput.value.trim();
            if (DOCTOR_CODES.includes(code)) {
                state.doctorUnlocked = true;
                closeModal();
                modeHint.textContent = "‚úì Unlocked";
                showPage("scannerPage");
                status.textContent = "Idle";
                document.getElementById("startBtn").style.display = "block";
                document.getElementById("pauseBtn").style.display = "none";
            } else {
                codeError.textContent = "‚ùå Incorrect code";
                codeInput.value = "";
            }
        }

        function goHome() {
            stopScanning();
            stopCamera();
            showPage("homePage");
        }

        async function startScanning() {
            status.textContent = "Scanning‚Ä¶";
            if (await startCamera()) {
                state.isScanning = true;
                state.isPaused = false;
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("pauseBtn").style.display = "block";
                document.getElementById("pauseBtn").textContent = "Pause";
                scanQR();
            }
        }

        function togglePause() {
            if (state.isPaused) {
                state.isScanning = true;
                state.isPaused = false;
                status.textContent = "Scanning‚Ä¶";
                document.getElementById("pauseBtn").textContent = "Pause";
                scanQR();
            } else {
                stopScanning();
                state.isPaused = true;
                stopCamera();
                status.textContent = "‚è∏ Paused";
                document.getElementById("pauseBtn").textContent = "Resume";
            }
        }

        async function rescan() {
            infoContainer.innerHTML = "";
            prescContainer.innerHTML = "";
            showPage("scannerPage");
            status.textContent = "Idle";
            document.getElementById("startBtn").style.display = "block";
            document.getElementById("pauseBtn").style.display = "none";
        }

        // ========== KEYBOARD SHORTCUTS ==========
        codeInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") submitCode();
        });

        doctorModal.addEventListener("click", (e) => {
            if (e.target === doctorModal) closeModal();
        });

        // ========== CLEANUP ==========
        window.addEventListener("beforeunload", () => {
            stopScanning();
            stopCamera();
        });

        // ========== INIT ==========
        showPage("homePage");
    </script>
</body>
</html>
